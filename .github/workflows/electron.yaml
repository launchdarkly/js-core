name: sdk/electron

on:
  push:
    branches: [main, 'feat/**']
    paths-ignore:
      - '**.md' #Do not need to run CI for markdown changes.
  pull_request:
    branches: [main, 'feat/**']
    paths-ignore:
      - '**.md'
  # TODO: re-enable this when we set up the example tests.
  # schedule:
  #   - cron: '0 0 * * *'

jobs:
  build-test-electron:
    # Skip this job on scheduled runs to avoid redundant runs.
    # TODO: re-enable this when we set up the example tests.
    # if: github.event_name != 'schedule'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # Node versions to run on.
        version: [24]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ matrix.version }}
          registry-url: 'https://registry.npmjs.org'
      - id: shared
        name: Shared CI Steps
        uses: ./actions/ci
        with:
          workspace_name: '@launchdarkly/electron-client-sdk'
          workspace_path: packages/sdk/electron

      # Contract Tests
      - name: Install contract test dependencies
        env:
          ELECTRON_DISABLE_SANDBOX: '1'
        run: |
            yarn workspaces focus @internal/electron-contract-tests-entity
            yarn workspace @internal/electron-contract-tests-entity build
            sudo apt-get install -y xvfb
            Xvfb :99 -screen 0 1024x768x24 > /tmp/xvfb.log 2>&1 &

      - name: run contract test entity
        env:
          ELECTRON_DISABLE_SANDBOX: '1'
          DISPLAY: ':99'
        run: |
          yarn workspace @internal/electron-contract-tests-entity open-electron &> /tmp/http-server.log &
          echo "Waiting for contract test entity on port 8000..."
          for i in {1..30}; do
            if curl -s http://localhost:8000 > /dev/null; then
              echo "Contract test entity ready"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "Timeout waiting for contract test entity"
              cat /tmp/http-server.log
              exit 1
            fi
            sleep 1
          done

      - name: Run contract tests
        uses: launchdarkly/gh-actions/actions/contract-tests@5adb11fd6953e1bc35d9cf1fc1b4374c464e3a8b
        with:
          test_service_port: 8000
          token: ${{ secrets.GITHUB_TOKEN }}
          extra_params: '--skip-from=${{ github.workspace }}/packages/sdk/electron/contract-tests/suppressions.txt --stop-service-at-end'

  # Example app verification
  # run-example:
  #   runs-on: ubuntu-latest
  #   permissions:
  #     id-token: write
  #   steps:
  #     - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
  #     - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
  #       with:
  #         node-version: 24
  #     - name: Setup Yarn
  #       run: yarn set version 3.4.1
  #     - name: Install dependencies
  #       run: yarn workspaces focus @internal/electron-example
  #     - name: Build SDK dependencies
  #       run: yarn workspaces foreach -pR --topological-dev --from '@internal/electron-example' run build
  #     - name: Install Xvfb
  #       run: sudo apt-get install -y xvfb
  #     - uses: launchdarkly/gh-actions/actions/verify-hello-app@verify-hello-app-v1.0.0
  #       with:
  #         use_mobile_key: true
  #         role_arn: ${{ vars.AWS_ROLE_ARN }}
  #         command: xvfb-run -a yarn workspace @internal/electron-example start -- --no-sandbox

